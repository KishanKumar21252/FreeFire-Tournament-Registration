<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QR Attendance System</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #007aff;
            --primary-gray: #f2f2f7;
            --secondary-gray: #e5e5ea;
            --text-color: #1c1c1e;
            --subtle-text: #636366;
            --background-color: #fff;
            --border-color: #d1d1d6;
        }

        body {
            font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-color);
            background-color: var(--primary-gray);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: var(--background-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: none;
            padding: 24px 0;
            border-radius: 0;
            animation: none;
        }

        .content-wrapper {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px;
        }

        h1, h2, h3 {
            text-align: center;
            font-weight: 500;
            color: var(--text-color);
            margin: 0;
            padding: 0;
        }

        h1 { font-size: 2.2rem; margin-bottom: 12px; }
        h2 { font-size: 1.5rem; margin-top: 20px; }
        h3 { font-size: 1.1rem; color: var(--subtle-text); margin-top: 15px; }

        nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
        }

        nav button {
            padding: 10px 18px;
            border: 1px solid transparent;
            border-radius: 8px;
            background-color: var(--secondary-gray);
            color: var(--text-color);
            font-size: 15px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }

        nav button:hover {
            background-color: var(--border-color);
        }

        nav button.active-tab {
            background-color: var(--primary-blue);
            color: #fff;
        }

        .tab {
            display: none;
            animation: fade-in 0.4s ease-out;
        }
        .active {
            display: block;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        label {
            display: block;
            margin: 15px 0 5px;
            font-weight: 400;
            color: var(--subtle-text);
        }

        input[type="text"], input[type="number"], input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: #fff;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .button-group {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        #genBtn, #markManual {
            background-color: var(--primary-blue);
            color: #fff;
        }
        #genBtn:hover, #markManual:hover { background-color: #0060d9; }

        #startScan { background-color: #34c759; color: #fff; }
        #startScan:hover { background-color: #2b9e4a; }
        #stopScan { background-color: #ff3b30; color: #fff; }
        #stopScan:hover { background-color: #e62e26; }

        .export-button {
            background-color: var(--secondary-gray);
            color: var(--text-color);
        }
        .export-button:hover { background-color: var(--border-color); }

        #qrCanvas, #preview {
            display: block;
            margin: 20px auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        #scanResult, #genStatus, #manualResult {
            text-align: center;
            font-size: 0.9rem;
            margin-top: 15px;
            font-weight: 500;
        }

        .status-message {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 500;
            display: inline-block;
        }
        .status-success {
            background-color: #e6f7e9;
            color: #219653;
        }
        .status-error {
            background-color: #ffeaea;
            color: #d63d3d;
        }

        ul, table {
            width: 100%;
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }

        li {
            background-color: var(--primary-gray);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        table {
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--secondary-gray);
            font-size: 0.9rem;
        }
        th {
            background-color: var(--secondary-gray);
            color: var(--text-color);
            font-weight: 500;
        }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: var(--border-color); }

    </style>
</head>
<body>
<div class="container">
    <div class="content-wrapper">
        <h1>QR Attendance</h1>
        <nav>
            <button data-tab="gen" class="active-tab">Generate QR</button>
            <button data-tab="scan">Scan QR</button>
            <button data-tab="manual">Manual</button>
            <button data-tab="students">Students</button>
            <button data-tab="attendance">Records</button>
            <button data-tab="reports">Reports</button>
        </nav>

        <div id="gen" class="tab active">
            <h2>Generate QR Code</h2>
            <label for="genRoll">Roll Number</label>
            <input id="genRoll" type="text" placeholder="e.g., 21CS01">
            <label for="genName">Name</label>
            <input id="genName" type="text" placeholder="e.g., John Doe">
            <label for="genClass">Class</label>
            <input id="genClass" type="text" placeholder="e.g., 12A">
            <div class="button-group">
                <button id="genBtn">Generate</button>
            </div>
            <div id="genStatus"></div>
            <canvas id="qrCanvas" width="250" height="250"></canvas>
            <a id="downloadBtn" style="display:none;" download="qr.png">Download QR</a>
        </div>

        <div id="scan" class="tab">
            <h2>Scan QR Code</h2>
            <video id="preview" width="300" height="200"></video>
            <div class="button-group" style="justify-content: center;">
                <button id="startScan">Start Scan</button>
                <button id="stopScan">Stop Scan</button>
            </div>
            <div id="scanResult"></div>
            <h3>Scan History</h3>
            <ul id="scanHistory"></ul>
        </div>

        <div id="manual" class="tab">
            <h2>Manual Attendance</h2>
            <label for="manualRoll">Roll Number</label>
            <input type="text" id="manualRoll" placeholder="e.g., 21CS01">
            <div class="button-group">
                <button id="markManual">Mark Attendance</button>
            </div>
            <div id="manualResult"></div>
            <h3>Manual History</h3>
            <ul id="manualHistory"></ul>
        </div>

        <div id="students" class="tab">
            <h2>Students</h2>
            <label for="importCSV">Import from CSV</label>
            <input type="file" id="importCSV" accept=".csv">
            <div class="button-group" style="justify-content: center;">
                <button id="exportStudents" class="export-button">Export Students CSV</button>
            </div>
            <ul id="stuList"></ul>
        </div>

        <div id="attendance" class="tab">
            <h2>Attendance Records</h2>
            <div class="button-group" style="justify-content: center;">
                <button id="exportRawAttendance" class="export-button">Export Raw Attendance CSV</button>
                <button id="exportStudentReport" class="export-button">Export Student Report</button>
                <button id="exportClassReport" class="export-button">Export Class Report</button>
            </div>
            <ul id="attList"></ul>
        </div>

        <div id="reports" class="tab">
            <h2>Monthly Attendance Report</h2>
            <label for="workingDays">Working Days for Month</label>
            <input type="number" id="workingDays" placeholder="e.g., 22">
            <div class="button-group" style="justify-content: center;">
                <button id="genReport">Generate Report</button>
            </div>
            <h3>Student-wise Report</h3>
            <table id="reportTable">
                <thead>
                <tr>
                    <th>Roll</th><th>Name</th><th>Class</th><th>Month</th>
                    <th>Attended</th><th>Total Days</th><th>%</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

            <h3>Class-wise Report</h3>
            <table id="classReportTable">
                <thead>
                <tr>
                    <th>Class</th><th>Month</th><th>Total Students</th>
                    <th>Total Days</th><th>Total Attendance</th><th>%</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
    // ---------- Storage ----------
    function loadStudents() { try { return JSON.parse(localStorage.getItem('students') || '[]'); } catch (e) { return []; } }
    function saveStudents(data) { localStorage.setItem('students', JSON.stringify(data)); }
    function loadAttendance() { try { return JSON.parse(localStorage.getItem('attendance') || '[]'); } catch (e) { return []; } }
    function saveAttendance(data) { localStorage.setItem('attendance', JSON.stringify(data)); }
    function saveWorkingDays(val) { localStorage.setItem('workingDays', val); }
    function loadWorkingDays() { return parseInt(localStorage.getItem('workingDays') || '0'); }

    // ---------- Tabs ----------
    document.querySelectorAll('nav button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('nav button').forEach(t => t.classList.remove('active-tab'));
            btn.classList.add('active-tab');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(btn.dataset.tab).classList.add('active');
            if (btn.dataset.tab === 'students') renderStudents();
            if (btn.dataset.tab === 'attendance') renderAttendance();
        });
    });
    document.querySelector('nav button').click();

    // ---------- Generate QR ----------
    const genBtn = document.getElementById('genBtn');
    const qrCanvas = document.getElementById('qrCanvas');
    const downloadBtn = document.getElementById('downloadBtn');
    const genStatus = document.getElementById('genStatus');
    let qr = null;

    genBtn.addEventListener('click', () => {
        const roll = document.getElementById('genRoll').value.trim();
        let name = document.getElementById('genName').value.trim();
        let cls = document.getElementById('genClass').value.trim();
        if (!roll) { alert('Enter roll number.'); return; }
        if (!name) name = "Unknown";
        if (!cls) cls = "N/A";

        const stuList = loadStudents();
        if (stuList.find(s => s.roll === roll)) {
            genStatus.innerHTML = '<span class="status-message status-error">❌ QR already generated for: ' + roll + '</span>';
            return;
        }
        stuList.push({ roll, name, class: cls });
        saveStudents(stuList);

        const payload = 'ATT|' + roll + '|' + name + '|' + cls;

        if (!qr) {
            qr = new QRious({
                element: qrCanvas,
                size: 250,
                level: 'H'
            });
        }
        qr.value = payload;

        downloadBtn.href = qrCanvas.toDataURL('image/png');
        downloadBtn.download = 'qr_' + roll + '.png';
        downloadBtn.style.display = 'block';
        genStatus.innerHTML = '<span class="status-message status-success">✔ QR generated successfully.</span>';
    });

    // ---------- Scanner ----------
    let codeReader = null, activeStream = null, lastScanned = "";
    document.getElementById('startScan').addEventListener('click', async () => {
        if (!codeReader) codeReader = new ZXing.BrowserQRCodeReader();
        const preview = document.getElementById('preview');
        try {
            if (activeStream) { activeStream.getTracks().forEach(track => track.stop()); }
            activeStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            preview.srcObject = activeStream; preview.setAttribute("playsinline", true);
            await preview.play();
            codeReader.decodeFromVideoDevice(null, preview, (result, err) => {
                if (result) {
                    const payload = result.getText();
                    if (payload !== lastScanned) {
                        lastScanned = payload;
                        handleScan(payload);
                        setTimeout(() => { lastScanned = ""; }, 2000);
                    }
                }
            });
        } catch (e) {
            console.error("Camera error:", e);
            alert("Could not access camera. Please ensure you have granted permission.");
        }
    });
    document.getElementById('stopScan').addEventListener('click', () => {
        if (activeStream) { activeStream.getTracks().forEach(track => track.stop()); activeStream = null; }
        document.getElementById('scanResult').textContent = "Scan stopped.";
    });

    // ---------- Handle Scan + Voice ----------
    function handleScan(payload) {
        let roll = '', name = 'Unknown', cls = 'N/A';
        const parts = (payload || '').split('|').map(p => p.trim());
        if (parts.length >= 4 && parts[0].toUpperCase() === 'ATT') { roll = parts[1]; name = parts[2]; cls = parts[3]; }
        else if (parts.length >= 3) { roll = parts[0]; name = parts[1]; cls = parts[2]; }
        else if (parts.length === 2) { roll = parts[0]; name = parts[1]; }
        else { roll = payload; }

        roll = roll || ''; name = name || 'Unknown'; cls = cls || 'N/A';

        const stuList = loadStudents();
        const studentExists = stuList.find(s => s.roll === roll);
        const recs = loadAttendance();
        const today = new Date().toISOString().slice(0, 10);

        if (!studentExists) {
            const msg = 'Invalid Roll Number: ' + roll;
            document.getElementById('scanResult').innerHTML = '<span class="status-message status-error">❌ ' + msg + '</span>';
            speak(msg);
            return;
        }

        if (recs.find(r => r.roll === roll && r.date === today)) {
            const msg = 'Attendance already marked for ' + name + ' (Roll: ' + roll + ')';
            document.getElementById('scanResult').innerHTML = '<span class="status-message status-error">❌ ' + msg + '</span>';
            speak(msg);
            showStudentHistory(roll, 'scanHistory');
            return;
        }

        recs.unshift({ roll, name, class: cls, ts: Date.now(), date: today });
        saveAttendance(recs);
        const msg = 'Attendance marked for ' + name + ' (Roll: ' + roll + ')';
        document.getElementById('scanResult').innerHTML = '<span class="status-message status-success">✅ ' + msg + ' — Class: ' + cls + '</span>';
        speak(msg);
        showStudentHistory(roll, 'scanHistory');
    }

    // ---------- Manual Attendance ----------
    document.getElementById('markManual').addEventListener('click', () => {
        const roll = document.getElementById('manualRoll').value.trim();
        const stuList = loadStudents();
        const studentExists = stuList.find(s => s.roll === roll);
        const recs = loadAttendance();
        const today = new Date().toISOString().slice(0, 10);

        if (!roll) {
            document.getElementById('manualResult').innerHTML = '<span class="status-message status-error">❌ Enter Roll Number</span>';
            speak('Enter Roll Number');
            return;
        }
        if (!studentExists) {
            const msg = 'Invalid Roll Number: ' + roll;
            document.getElementById('manualResult').innerHTML = '<span class="status-message status-error">❌ ' + msg + '</span>';
            speak(msg);
            return;
        }

        const name = studentExists.name;
        const cls = studentExists.class || 'N/A';

        if (recs.find(r => r.roll === roll && r.date === today)) {
            const msg = 'Attendance already marked for ' + name + ' (Roll: ' + roll + ')';
            document.getElementById('manualResult').innerHTML = '<span class="status-message status-error">❌ ' + msg + '</span>';
            speak(msg);
            showStudentHistory(roll, 'manualHistory');
            return;
        }

        recs.unshift({ roll, name, class: cls, ts: Date.now(), date: today });
        saveAttendance(recs);
        const msg = 'Attendance marked for ' + name + ' (Roll: ' + roll + ')';
        document.getElementById('manualResult').innerHTML = '<span class="status-message status-success">✅ ' + msg + ' — Class: ' + cls + '</span>';
        speak(msg);
        showStudentHistory(roll, 'manualHistory');
        document.getElementById('manualRoll').value = '';
    });

    // ---------- Voice ----------
    function speak(text) {
        try {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = "en-IN";
                window.speechSynthesis.speak(utter);
            }
        } catch (e) { console.error('Speech error', e); }
    }

    // ---------- Show History ----------
    function showStudentHistory(roll, ulId) {
        const recs = loadAttendance().filter(r => r.roll === roll);
        const ul = document.getElementById(ulId);
        ul.innerHTML = '';
        if (recs.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'No attendance records found for this roll.';
            ul.appendChild(li);
            return;
        }
        recs.forEach(r => {
            const classText = r.class || 'N/A';
            const li = document.createElement('li');
            li.textContent = r.date + ' — ' + r.roll + ' — ' + r.name + ' — Class: ' + classText;
            ul.appendChild(li);
        });
    }

    // ---------- Students & Attendance ----------
    function renderStudents() {
        const ul = document.getElementById('stuList');
        ul.innerHTML = '';
        loadStudents().forEach(s => {
            const li = document.createElement('li');
            li.textContent = s.roll + ' — ' + s.name + ' — ' + (s.class || 'N/A');
            ul.appendChild(li);
        });
    }

    function renderAttendance() {
        const ul = document.getElementById('attList');
        ul.innerHTML = '';
        loadAttendance().forEach(r => {
            const classText = r.class || 'N/A';
            const li = document.createElement('li');
            li.textContent = r.date + ' ' + new Date(r.ts).toLocaleTimeString() + ' — ' + r.roll + ' — ' + r.name + ' — Class: ' + classText;
            ul.appendChild(li);
        });
    }

    // ---------- CSV ----------
    function downloadCSV(data, filename) {
        const blob = new Blob([data], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }

    document.getElementById('exportStudents').addEventListener('click', () => {
        const stu = loadStudents();
        let csv = "roll,name,class\n";
        stu.forEach(s => { csv += escapeCsv(s.roll) + ',' + escapeCsv(s.name) + ',' + escapeCsv(s.class) + '\n'; });
        downloadCSV(csv, "students.csv");
    });
    document.getElementById('exportRawAttendance').addEventListener('click', () => {
        const recs = loadAttendance();
        let csv = "roll,name,class,timestamp,date\n";
        recs.forEach(r => { csv += escapeCsv(r.roll) + ',' + escapeCsv(r.name) + ',' + escapeCsv(r.class || r.cls) + ',' + r.ts + ',' + r.date + '\n'; });
        downloadCSV(csv, "attendance_raw.csv");
    });

    function escapeCsv(val) {
        if (val == null) return '';
        const str = String(val);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
    }

    document.getElementById('importCSV').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => importCSV(ev.target.result);
        reader.readAsText(file);
    });

    function importCSV(text) {
        const lines = (text || '').trim().split(/\r?\n/);
        const stu = loadStudents();
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const cols = line.split(/,(?=(?:(?:[^"]"){2})[^"]*$)/);
            if (cols.length < 2) continue;
            if (i === 0 && /^roll$/i.test(cols[0].trim())) continue;
            const roll = (cols[0] || '').trim().replace(/^"|"$/g, '').replace(/""/g, '"');
            const name = (cols[1] || '').trim().replace(/^"|"$/g, '').replace(/""/g, '"');
            const cls = (cols[2] || 'N/A').trim().replace(/^"|"$/g, '').replace(/""/g, '"');
            if (roll && name && !stu.find(s => s.roll === roll)) stu.push({ roll, name, class: cls });
        }
        saveStudents(stu);
        renderStudents();
        alert("Students imported successfully!");
    }

    // ---------- Reports ----------
    function calculateReport() {
        const recs = loadAttendance();
        const workingDaysInput = parseInt(document.getElementById('workingDays').value) || 0;
        saveWorkingDays(workingDaysInput);
        const studentReport = {}, classReport = {};

        recs.forEach(r => {
            const d = new Date(r.date);
            const monthKey = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
            const stuKey = r.roll + '|' + monthKey;
            if (!studentReport[stuKey]) studentReport[stuKey] = { roll: r.roll, name: r.name, class: r.class || 'N/A', month: monthKey, days: new Set() };
            studentReport[stuKey].days.add(r.date);
        });

        const studentRows = [];
        for (const k in studentReport) {
            const item = studentReport[k];
            const parts = item.month.split('-').map(Number);
            const totalDays = workingDaysInput > 0 ? workingDaysInput : new Date(parts[0], parts[1], 0).getDate();
            const attended = item.days.size;
            const perc = totalDays > 0 ? ((attended / totalDays) * 100).toFixed(1) : '0.0';
            studentRows.push({ roll: item.roll, name: item.name, class: item.class, month: item.month, attended: attended, totalDays: totalDays, perc: perc });
        }

        studentRows.forEach(r => {
            const key = r.class + '|' + r.month;
            if (!classReport[key]) classReport[key] = { class: r.class, month: r.month, totalStudents: 0, totalDays: r.totalDays, totalAttendance: 0 };
            classReport[key].totalStudents += 1;
            classReport[key].totalAttendance += r.attended;
        });

        const classRows = [];
        for (const k in classReport) {
            const c = classReport[k];
            const maxPossible = c.totalStudents * c.totalDays;
            const perc = maxPossible > 0 ? ((c.totalAttendance / maxPossible) * 100).toFixed(1) : '0.0';
            classRows.push({ class: c.class, month: c.month, totalStudents: c.totalStudents, totalDays: c.totalDays, totalAttendance: c.totalAttendance, perc: perc });
        }

        return { studentRows, classRows };
    }

    document.getElementById('genReport').addEventListener('click', () => {
        const { studentRows, classRows } = calculateReport();
        const tbody = document.querySelector('#reportTable tbody');
        tbody.innerHTML = '';
        studentRows.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td>' + r.roll + '</td><td>' + r.name + '</td><td>' + r.class + '</td><td>' + r.month + '</td><td>' + r.attended + '</td><td>' + r.totalDays + '</td><td>' + r.perc + '%</td>';
            tbody.appendChild(tr);
        });
        const tbody2 = document.querySelector('#classReportTable tbody');
        tbody2.innerHTML = '';
        classRows.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td>' + c.class + '</td><td>' + c.month + '</td><td>' + c.totalStudents + '</td><td>' + c.totalDays + '</td><td>' + c.totalAttendance + '</td><td>' + c.perc + '%</td>';
            tbody2.appendChild(tr);
        });
    });

    document.getElementById('exportStudentReport').addEventListener('click', () => {
        const { studentRows } = calculateReport();
        let csv = "roll,name,class,month,attended,totalDays,percentage\n";
        studentRows.forEach(r => { csv += escapeCsv(r.roll) + ',' + escapeCsv(r.name) + ',' + escapeCsv(r.class) + ',' + r.month + ',' + r.attended + ',' + r.totalDays + ',' + r.perc + '%\n'; });
        downloadCSV(csv, "student_report.csv");
    });
    document.getElementById('exportClassReport').addEventListener('click', () => {
        const { classRows } = calculateReport();
        let csv = "class,month,totalStudents,totalDays,totalAttendance,percentage\n";
        classRows.forEach(c => { csv += escapeCsv(c.class) + ',' + c.month + ',' + c.totalStudents + ',' + c.totalDays + ',' + c.totalAttendance + ',' + c.perc + '%\n'; });
        downloadCSV(csv, "class_report.csv");
    });
</script>
</body>
</html>